<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Alphabet World Map Game</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
    background: #121212;
    color: #eee;
  }
  h1 { margin: 1em 0 0.3em; }
  #map { width: 100%; height: 70vh; border: 1px solid #444; background: #1e1e1e; border-radius: 12px; }
  #controls {
    margin: 1em;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  input[type=text] {
    padding: 0.5em;
    width: 250px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #222;
    color: #eee;
    flex-shrink: 0;
  }
  button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: #007acc;
    color: #fff;
    cursor: pointer;
    font-family: 'Material Symbols Rounded';
    font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 48;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  button:hover { background: #005f99; }
  #autocomplete-list {
    position: absolute;
    top: 4em;
    left: 0;
    width: 250px;
    border: 1px solid #555;
    border-radius: 8px;
    background: #222;
    max-height: 150px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
  }
  .autocomplete-item {
    padding: 0.3em 0.5em;
    cursor: pointer;
  }
  .autocomplete-item:hover {
    background: #444;
  }
  .country { fill: none; stroke: #555; stroke-width: 0.5px; }
  .revealed { fill: steelblue; stroke: #fff; stroke-width: 1px; }
  .label { font-size: 8px; text-anchor: middle; fill: #fff; }
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
</head>

<body>
<h1>Alphabet Map Game</h1>
<div id="controls">
  <div id="prompt">Loading game...</div>
  <input id="answer" type="text" placeholder="Type country name" autocomplete="off">
  <div id="autocomplete-list"></div>
  <button id="submit-btn">
    <span class="material-symbols-rounded" style="font-variation-settings: 'FILL' 1; font-size:24px;">
      arrow_forward_ios
    </span>
  </button>
</div>
<svg id="map"></svg>

<script>
let countriesData = [];
let features = [];
let projection, path, svg;
let round = 1;
let currentContinent = "";
let currentLetter = "";
let revealedCountries = new Set();
let nameIndex = new Map();
let isoIndex = new Map();
let featureByCCA3 = new Map();
let featureByName = new Map();

// Helper to normalise names
function normalizeName(s) {
  return s.toLowerCase().replace(/[^a-z]/g,'');
}

async function init() {
  svg = d3.select("#map");
  projection = d3.geoMercator().scale(120).translate([window.innerWidth/2, window.innerHeight/2.2]);
  path = d3.geoPath().projection(projection);

  const rc = await fetch('https://restcountries.com/v3.1/all?fields=cca3,name,region,altSpellings')
    .then(r => r.json());

  rc.forEach(c => {
    const cca3 = c.cca3 || "";
    const common = c.name.common;
    const region = c.region || "Other";
    const aliases = new Set([common, c.name.official, ...(c.altSpellings||[])].filter(Boolean));
    const rec = { name: common, cca3, region, aliases:[...aliases] };
    countriesData.push(rec);
    isoIndex.set(cca3, rec);
    rec.aliases.forEach(a => nameIndex.set(normalizeName(a), rec));
  });

  const topo = await fetch('https://unpkg.com/world-atlas@2/countries-50m.json').then(r => r.json());
  const objKey = Object.keys(topo.objects)[0];
  features = topojson.feature(topo, topo.objects[objKey]).features;
  features.forEach(f => {
    const props = f.properties || {};
    const iso = props.iso_a3 || props.ISO_A3 || props.ADM0_A3 || "";
    const pname = props.name || props.NAME || props.ADMIN || "";
    if(iso) featureByCCA3.set(iso, f);
    if(pname) featureByName.set(normalizeName(pname), f);
  });

  svg.selectAll("path")
    .data(features)
    .join("path")
    .attr("d", path)
    .attr("class", "country");

  nextRound();
}

// Next round logic
function nextRound() {
  const submitSpan = document.querySelector("#submit-btn span");
  submitSpan.textContent = "arrow_forward_ios";
  submitSpan.style.fontSize = "24px";

  const remaining = countriesData.filter(c => !revealedCountries.has(c.name) && c.region !== "Antarctic");
  if (remaining.length === 0) {
    document.getElementById("prompt").innerText = "Game over! All countries revealed.";
    return;
  }

  const rec = remaining[Math.floor(Math.random() * remaining.length)];
  currentContinent = rec.region;
  currentLetter = rec.name[0].toUpperCase();

  document.getElementById("prompt").innerText =
    `Round ${round}: Name a country in ${currentContinent} starting with "${currentLetter}"`;
}

// Autocomplete
const answerInput = document.getElementById("answer");
const autocompleteList = document.getElementById("autocomplete-list");

answerInput.addEventListener("input", function() {
  const val = normalizeName(this.value);
  autocompleteList.innerHTML = "";
  if (!val) return;
  let matches = countriesData.map(c=>c.name)
    .filter(n=>normalizeName(n).startsWith(val) && !revealedCountries.has(n));
  matches.slice(0,10).forEach(name=>{
    const div = document.createElement("div");
    div.classList.add("autocomplete-item");
    div.textContent = name;
    div.onclick = ()=>{
      answerInput.value = name;
      autocompleteList.innerHTML = "";
      submitAnswer();
    };
    autocompleteList.appendChild(div);
  });
});
document.addEventListener("click", e => { if(e.target !== answerInput) autocompleteList.innerHTML = ""; });
answerInput.addEventListener("keydown", e => { if(e.key==="Enter"){ submitAnswer(); autocompleteList.innerHTML=""; } });

function submitAnswer() {
  const input = answerInput.value.trim();
  answerInput.value = "";
  autocompleteList.innerHTML = "";
  if(!input) return;

  // Special command: reveal all countries
  if(input === "&revealAllCountries&") {
    countriesData.forEach(rec => {
      if(!revealedCountries.has(rec.name)) {
        revealedCountries.add(rec.name);
        revealCountry(rec);
      }
    });
    document.getElementById("prompt").innerText = "All countries revealed!";
    return;
  }

  const rec = nameIndex.get(normalizeName(input));
  const submitSpan = document.querySelector("#submit-btn span");

  if(!rec){
    alert(`❌ Invalid input: ${input}`);
    return;
  }
  if(rec.region !== currentContinent){
    alert(`❌ Wrong continent: ${rec.name} is in ${rec.region}`);
    return;
  }
  if(!rec.name.startsWith(currentLetter)){
    alert(`❌ Wrong letter: ${rec.name} does not start with ${currentLetter}`);
    return;
  }

  submitSpan.textContent = "check_circle";
  submitSpan.style.fontSize = "36px";

  revealedCountries.add(rec.name);
  revealCountry(rec);
  round++;
  setTimeout(nextRound, 500);
}

function revealCountry(rec) {
  const f = featureByCCA3.get(rec.cca3) || featureByName.get(normalizeName(rec.name));
  if(!f) return;
  svg.append("path").datum(f).attr("d", path).attr("class","revealed");
  const [x,y] = path.centroid(f);
  svg.append("text").attr("x",x).attr("y",y).attr("class","label").text(rec.name);
}

init();
</script>
</body>
</html>
